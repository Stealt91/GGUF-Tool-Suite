# Faster than other KT recipes recipes produced so far but terrible PPL, likely because GPU weight it too high compared to CPU weight.
## Quant mix recipe created using Thireus' GGUF Tool Suite - https://gguf.thireus.com/
# Model name: GLM-4.5
# Link to the original model: https://huggingface.co/zai-org/GLM-4.5

## Model head & embeddings — qbits: 32 6 4 
output_norm\.weight=f32
token_embd\.weight=iq4_kt
output\.weight=iq6_k

## Multi-headed attention parameters — qbits: 32 4 
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_output\.weight=iq4_kt
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_k\.bias=f32
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_k\.weight=iq4_kt
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_q\.weight=iq4_kt
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_v\.weight=iq4_kt
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_q\.bias=f32
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_k_norm\.weight=f32
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_v\.bias=f32
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_norm\.weight=f32
blk\.([0-9]|[1-8][0-9]|9[0-2])\.attn_q_norm\.weight=f32

## Core FFN weights — qbits: 32 6 4 
blk\.2\.ffn_down\.weight=iq6_k
blk\.[0-2]\.ffn_up\.weight=iq4_kt
blk\.([3-9]|[1-8][0-9]|9[0-2])\.ffn_gate_inp\.weight=f32
blk\.[0-2]\.ffn_gate\.weight=iq4_kt
blk\.[0-1]\.ffn_down\.weight=iq4_kt

## Other tensors — qbits: 32 4 
blk\.92\.nextn\.eh_proj\.weight=iq4_kt
blk\.92\.nextn\.shared_head_head\.weight=iq4_kt
blk\.([0-9]|[1-8][0-9]|9[0-2])\.post_attention_norm\.weight=f32
blk\.92\.nextn\.shared_head_norm\.weight=f32
blk\.([3-9]|[1-8][0-9]|9[0-2])\.exp_probs_b\.bias=f32
blk\.92\.nextn\.embed_tokens\.weight=iq4_kt
blk\.92\.nextn\.enorm\.weight=f32
blk\.92\.nextn\.hnorm\.weight=f32

## GPU-loaded ffn_*_shexp
# ffn_down_shexp (down-projection) — qbits: 6 4 
blk\.(30|32|91|2[8-9])\.ffn_down_shexp\.weight=iq6_k
blk\.([3-9]|31|[4-8][0-9]|90|92|2[0-7]|1[0-9]|3[3-9])\.ffn_down_shexp\.weight=iq4_kt

# ffn_up_shexp (up-projection) — qbits: 6 4 
blk\.(31|35|91|3[8-9])\.ffn_up_shexp\.weight=iq6_k
blk\.([3-9]|[1-2][0-9]|30|[4-8][0-9]|90|92|3[6-7]|3[2-4])\.ffn_up_shexp\.weight=iq4_kt

# ffn_gate_shexp (gate-projection) — qbits: 6 4 
blk\.(30|36|46|86|9[0-1])\.ffn_gate_shexp\.weight=iq6_k
blk\.([3-9]|[1-2][0-9]|[5-7][0-9]|92|4[0-5]|8[0-5]|[3-4][7-9]|8[7-9]|3[1-5])\.ffn_gate_shexp\.weight=iq4_kt

## CPU-loaded ffn_*_exps
# ffn_down_exps (down-extraction) — qbits: 4 3 2 1 
blk\.92\.ffn_down_exps\.weight=iq4_kt
blk\.(30|35)\.ffn_down_exps\.weight=iq3_kt
blk\.(3|18)\.ffn_down_exps\.weight=iq2_kt
blk\.([4-9]|19|[4-8][0-9]|1[0-7]|2[0-9]|9[0-1]|3[1-4]|3[6-9])\.ffn_down_exps\.weight=iq1_kt

# ffn_up_exps (up-extraction) — qbits: 4 3 1 
blk\.92\.ffn_up_exps\.weight=iq4_kt
blk\.24\.ffn_up_exps\.weight=iq3_kt
blk\.([3-9]|[3-8][0-9]|1[0-9]|2[5-9]|9[0-1]|2[0-3])\.ffn_up_exps\.weight=iq1_kt

# ffn_gate_exps (gate-extraction) — qbits: 4 3 1 
blk\.92\.ffn_gate_exps\.weight=iq4_kt
blk\.(19|20|28|3[0-1]|2[2-3])\.ffn_gate_exps\.weight=iq3_kt
blk\.([3-9]|21|29|[4-8][0-9]|3[2-9]|2[4-7]|9[0-1]|1[0-8])\.ffn_gate_exps\.weight=iq1_kt

## Summary of tensor sizes per class
# GPU Total: 9.204 GiB (90.2%) | 10.21 GiB max, if all were iq6_k | 8.91 GiB min, if all were iq4_kt
# CPU Total: 72.327 GiB (58.3%) | 123.98 GiB max, if all were iq3_kt | 70.20 GiB min, if all were iq1_kt
# GPU+CPU Total: 81.530 GiB (74.3%)

## Summary of tensor counts and bpw per qtype
#
# GPU-loaded quants:
# QTYPE		Count	BPW	Assigned GiB	% Assigned	Max GiB (all)
# +f32       	835	32.0  	  0.28 GiB	-		-
# iq6_k     	18 	6.625 	  0.74 GiB	22.7%		3.27
# iq5_k_r4  	0  	5.5   	  0.00 GiB	0.0%		2.72
# +iq4_kt    	375	4.0   	  6.65 GiB	-		-
# iq4_kt    	263	4.0   	  1.53 GiB	77.3%		1.98
#
# CPU-loaded quants:
# QTYPE		Count	BPW	Assigned GiB	% Assigned	Max GiB (all)
# +iq4_kt    	3  	4.0   	  1.76 GiB	-		-
# iq3_kt    	10 	3.125 	  4.58 GiB	3.7%		122.22
# iq2_kt    	2  	2.125 	  0.62 GiB	0.7%		83.11
# iq1_kt    	255	1.75  	 65.37 GiB	95.5%		68.44
#
# -Average BPW: 1.9544
#
# -Notes:
# - '+' means user-defined pre-assigned tensors, or tensor missing from csv data or f32 tensors
# - Recipe produced on the 2025-08-08 14:14:38 UTC+0000 using Thireus' GGUF tools (https://gguf.thireus.com/)
# - Script SHA-256: a02563df96ccec6c78ab7c716771153ae5f5ef4e9ee6a04d372f273eb1662e9c
# - Calibration dataset 'ppl_results.csv' SHA-256: eee3f314cf1ecaa746932341b2189f8a7718e62489bbd250f957c4aec82c0015
# - tensors.bf16.map SHA-256: 4e8b7b435f6257174a7adfc90290ac92c36758fef201ba0f5358338eea7606b8
# - tensors.bf16.map model name: GLM-4.5-THIREUS-BF16-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq3_kt.map SHA-256: 6db35592713504d0ba2831f8639658bfcedded822d7b0f869ea5a38c86d299f3
# - tensors.iq3_kt.map model name: GLM-4.5-THIREUS-IQ3_KT-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq2_kt.map SHA-256: 7f17a966ff370632ec639c844f65a564309a007e1ed2c117c4c5a41e62e26ad4
# - tensors.iq2_kt.map model name: GLM-4.5-THIREUS-IQ2_KT-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq1_kt.map SHA-256: d376bb126ffe99d3c86287926a8c43e9a3b3af7600772a3e832e98b4b46569fc
# - tensors.iq1_kt.map model name: GLM-4.5-THIREUS-IQ1_KT-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq4_kt.map SHA-256: 19448602b9da7236aead74dac88a1bceaacb40e4a01ef6d6fdd491412f6f3035
# - tensors.iq4_kt.map model name: GLM-4.5-THIREUS-IQ4_KT-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq5_k_r4.map SHA-256: c13be13e7b38a6206c03c5c77d5fda27e281b38fff35a1cbe26c024d8cc98741
# - tensors.iq5_k_r4.map model name: GLM-4.5-THIREUS-IQ5_K_R4-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq6_k.map SHA-256: 8ef4d5c379126fc13dfb46bbc8c10308d2c8e78602c0b3f6cea197d963fc80f1
# - tensors.iq6_k.map model name: GLM-4.5-THIREUS-IQ6_K-SPECIAL_TENSOR-01762-of-01762
# - tensors.iq2_ks.map SHA-256: 4ed9fc5a73d854ad30f9f75577a1d826150cb23283a0bb54dba45d6aba6c9de2
# - tensors.iq2_ks.map model name: GLM-4.5-THIREUS-IQ2_KS-SPECIAL_TENSOR-01762-of-01762
# - GPG signatures: PASSED
# - Command used:
# ../../quant_assign.py ppl_results.csv --tolerance 0.01 --cpu-irq-k 1.5 --gpu-irq-k 1.5 --gpu-assign-qtype iq4_kt \
# --cpu-tensors-max-size 73 --gpu-tensors-max-size 88% --exponential-factor 8 --cpu-tensors \
# 'blk\.([3-9]|[1-8][0-9]|9[0-1])\.ffn_down_exps\.weight' 'blk\.([3-9]|[1-8][0-9]|9[0-1])\.ffn_up_exps\.weight' \
# 'blk\.([3-9]|[1-8][0-9]|9[0-1])\.ffn_gate_exps\.weight' --gpu-tensors '.*' --cpu-quants iq3_kt iq2_kt iq1_kt \
# --gpu-quants iq4_kt iq5_k_r4 iq6_k --cpu-assign-tensors 'blk\.(92)\.ffn_down_exps\.weight=iq4_kt' \
# 'blk\.(92)\.ffn_up_exps\.weight=iq4_kt' 'blk\.(92)\.ffn_gate_exps\.weight=iq4_kt'

## THE END!
